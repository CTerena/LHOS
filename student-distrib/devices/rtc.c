#include "rtc.h"
#include "../lib.h"
#include "../i8259.h"

uint32_t rtc_time_counter;

/* RTC_init - Initialization of Real-Time Clock (RTC)
 * 
 * Initializes the RTC to a base frequency of 1024.
 * 
 * Inputs: none
 * Outputs: none (Configuration of RTC registers)
 * Side Effects: Modifies RTC control registers A and B. Resets the rtc_time_counter and enables
 *               the RTC interrupt request line (IRQ).
 */
void RTC_init(void) {
    printf("RTC_init\n");
    char prev;
    outb(RTC_B, RTC_PORT);     // select register B, and disable NMI
    prev = inb(RTC_CMOS_PORT); // read the current value of register B
    outb(RTC_B, RTC_PORT);     // set the index again (inb will reset the idx)
    /* write the previous value ORed with 0x40. This turns on bit 6 of register B */
    outb(prev | 0x40, RTC_CMOS_PORT);

    outb(RTC_A, RTC_PORT);     // set index to register A, disable NMI
    prev = inb(RTC_CMOS_PORT); // get the previous value of register B
    outb(RTC_A, RTC_PORT);     // set the index again
    outb((prev & 0xF0) | RTC_BASE_FRE, RTC_CMOS_PORT);  // set the frequency to 2 Hz

    rtc_time_counter = 0;
    enable_irq(RTC_IRQ);
}

/* __intr_RTC_handler - Real-Time Clock (RTC) Interrupt Handler
 * 
 * Handles interrupts generated by the RTC.
 * 
 * Inputs: None (Triggered by RTC interrupt)
 * Outputs: None (Handles interrupt side effects)
 * Side Effects: Increments rtc_time_counter. Acknowledges RTC interrupt by reading from register C.
 *               Sends EOI to the RTC IRQ. Potentially triggers other interrupt handlers through the
 *               test_interrupts() function.
 */
void __intr_RTC_handler(void) {
    cli();
    rtc_time_counter ++;

    /* for cp1 */
    test_interrupts();

    outb(RTC_C &0x0F, RTC_PORT); // select register C
    inb(RTC_CMOS_PORT);		    // just throw away contents

    send_eoi(RTC_IRQ);
    sti();
}
